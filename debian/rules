#!/usr/bin/make -f
#
# Bootstrap a minimal fbc setup based on precompiled compiler sources
#
# 1. Build rtlib/gfxlib2 (it's written in C, no bootstrapping needed)
# 2. Assemble the precompiled src/compiler/*.asm into .o
# 3. Create the new bin/fbc from those .o, linked against that rtlib
#
# This assumes that the precompiled .asm is compatible with the rtlib!
# Ideally the .asm should have been generated by this same FB version.
#

%:
	dh $@ 

objs := $(patsubst %.bas,%.o,$(wildcard src/compiler/*.bas))
$(objs): %.o: %.asm
	as --strip-local-absolute $< -o $@

.PHONY: rtlib
rtlib:
	make rtlib gfxlib2

bin/fbc: $(objs)
	mkdir -p bin
	gcc -o bin/fbc lib/freebasic/linux-x86/fbrt0.o src/compiler/*.o \
		lib/freebasic/linux-x86/libfb.a -lncurses -lm -pthread

override_dh_auto_build: rtlib bin/fbc

override_dh_auto_install:
	mkdir -p debian/freebasic-bootstrap/usr
	make install prefix=debian/freebasic-bootstrap/usr
